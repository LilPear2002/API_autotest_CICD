{% extends "base.html" %}

{% block title %}文件管理 - Flask商城{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 id="files-title">文件管理</h2>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal" id="upload-btn">
        <i class="bi bi-upload"></i> 上传文件
    </button>
</div>

{% if files %}
<div class="table-responsive" id="files-table-container">
    <table class="table" id="files-table">
        <thead>
            <tr>
                <th>文件名</th>
                <th>类型</th>
                <th>大小</th>
                <th>上传时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="files-list">
            {% for file in files %}
            <tr id="file-row-{{ file.id }}">
                <td id="file-name-{{ file.id }}">{{ file.original_filename }}</td>
                <td id="file-type-{{ file.id }}">{{ file.file_type }}</td>
                <td id="file-size-{{ file.id }}">{{ "%.2f"|format(file.file_size / 1024) }} KB</td>
                <td id="file-time-{{ file.id }}">{{ file.upload_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <a href="/api/files/{{ file.id }}/download" class="btn btn-sm btn-outline-primary" id="file-download-{{ file.id }}">下载</a>
                    <button type="button" class="btn btn-sm btn-outline-danger delete-file-btn" data-id="{{ file.id }}" id="file-delete-{{ file.id }}">删除</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if pagination.pages > 1 %}
<nav id="pagination">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('main.files', page=pagination.prev_num) }}" id="page-prev">上一页</a>
        </li>
        {% endif %}
        {% for page in pagination.iter_pages() %}
        {% if page %}
        <li class="page-item {% if page == pagination.page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('main.files', page=page) }}" id="page-{{ page }}">{{ page }}</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endfor %}
        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('main.files', page=pagination.next_num) }}" id="page-next">下一页</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5" id="no-files">
    <i class="bi bi-folder2-open" style="font-size: 4rem; color: #ccc;"></i>
    <p class="mt-3 text-muted">暂无文件</p>
</div>
{% endif %}

<!-- 上传弹窗 -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="upload-modal-title">上传文件</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">选择文件</label>
                        <input type="file" class="form-control" id="file" name="file" required>
                        <div class="form-text">支持: png, jpg, jpeg, gif, pdf, doc, docx, txt (最大16MB)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="upload-cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-upload-btn">上传</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
var token = '{{ session.token }}';

// 上传文件
document.getElementById('confirm-upload-btn').addEventListener('click', function() {
    var fileInput = document.getElementById('file');
    if (!fileInput.files.length) {
        alert('请选择文件');
        return;
    }
    
    var formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    fetch('/api/files/upload', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 201) {
            alert('上传成功');
            location.reload();
        } else {
            alert(data.message);
        }
    });
});

// 删除文件
document.querySelectorAll('.delete-file-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        if (!confirm('确定删除？')) return;
        var id = this.dataset.id;
        
        fetch('/api/files/' + id, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(data => {
            if (data.code === 200) {
                location.reload();
            } else {
                alert(data.message);
            }
        });
    });
});
</script>
{% endblock %}
