{% extends "base.html" %}

{% block title %}{{ product.name }} - Flask商城{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" id="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">首页</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('main.products') }}">商品</a></li>
        <li class="breadcrumb-item active">{{ product.name }}</li>
    </ol>
</nav>

<div class="row" id="product-detail">
    <div class="col-md-5 mb-4">
        {% if product.image_url %}
        <img src="{{ product.image_url }}" class="img-fluid rounded" alt="{{ product.name }}" id="product-image">
        {% else %}
        <div class="bg-secondary d-flex align-items-center justify-content-center rounded" style="height: 400px;">
            <i class="bi bi-image text-white" style="font-size: 5rem;"></i>
        </div>
        {% endif %}
    </div>
    <div class="col-md-7">
        <h2 id="product-name">{{ product.name }}</h2>
        <p class="text-muted" id="product-category">
            分类: {{ product.category.name if product.category else '未分类' }}
        </p>
        <h3 class="text-danger" id="product-price">¥{{ "%.2f"|format(product.price) }}</h3>
        <p id="product-stock">
            {% if product.stock > 0 %}
            <span class="badge bg-success">有货</span> 库存: {{ product.stock }}
            {% else %}
            <span class="badge bg-danger">已售罄</span>
            {% endif %}
        </p>
        <hr>
        <div class="mb-3" id="product-description">
            <h5>商品描述</h5>
            <p>{{ product.description or '暂无描述' }}</p>
        </div>
        
        {% if session.user_id %}
        <form id="add-to-cart-form" class="d-flex align-items-center gap-3">
            <div class="input-group" style="width: 150px;">
                <button type="button" class="btn btn-outline-secondary" id="quantity-minus">-</button>
                <input type="number" class="form-control text-center" id="quantity" name="quantity" value="1" min="1" max="{{ product.stock }}">
                <button type="button" class="btn btn-outline-secondary" id="quantity-plus">+</button>
            </div>
            <button type="submit" class="btn btn-primary" id="add-to-cart-btn" {% if product.stock == 0 %}disabled{% endif %}>
                <i class="bi bi-cart-plus"></i> 加入购物车
            </button>
        </form>
        {% else %}
        <a href="{{ url_for('main.login') }}" class="btn btn-primary" id="login-to-buy">登录后购买</a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('quantity-minus').addEventListener('click', function() {
    var input = document.getElementById('quantity');
    if (parseInt(input.value) > 1) {
        input.value = parseInt(input.value) - 1;
    }
});

document.getElementById('quantity-plus').addEventListener('click', function() {
    var input = document.getElementById('quantity');
    var max = parseInt(input.max);
    if (parseInt(input.value) < max) {
        input.value = parseInt(input.value) + 1;
    }
});

document.getElementById('add-to-cart-form').addEventListener('submit', function(e) {
    e.preventDefault();
    var quantity = document.getElementById('quantity').value;
    var token = '{{ session.token }}';
    
    fetch('/api/cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
            product_id: {{ product.id }},
            quantity: parseInt(quantity)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 200 || data.code === 201) {
            alert('添加成功');
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        alert('操作失败');
    });
});
</script>
{% endblock %}
